import json
import os
from datetime import datetime
from zoneinfo import ZoneInfo

import gspread
from google.oauth2.service_account import Credentials
from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update
from telegram.ext import (
    Application,
    CallbackQueryHandler,
    CommandHandler,
    ContextTypes,
    MessageHandler,
    filters,
)

TZ = ZoneInfo(os.getenv("TIMEZONE", "Asia/Almaty"))

SPREADSHEET_ID = os.environ["SPREADSHEET_ID"]
TELEGRAM_TOKEN = os.environ["TELEGRAM_TOKEN"]
GOOGLE_SA_JSON = os.environ["GOOGLE_SA_JSON"]  # JSON —Å—Ç—Ä–æ–∫–æ–π


def sheets_client():
    info = json.loads(GOOGLE_SA_JSON)
    scopes = [
        "https://www.googleapis.com/auth/spreadsheets",
        "https://www.googleapis.com/auth/drive",
    ]
    creds = Credentials.from_service_account_info(info, scopes=scopes)
    gc = gspread.authorize(creds)
    return gc


def append_row(tab_name: str, row: list):
    gc = sheets_client()
    sh = gc.open_by_key(SPREADSHEET_ID)
    ws = sh.worksheet(tab_name)
    ws.append_row(row, value_input_option="USER_ENTERED")


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Health Bot –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ö–æ–º–∞–Ω–¥—ã: /morning /weekly /buttons")


async def buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = [
        [
            InlineKeyboardButton("–î–∞", callback_data="test_yes"),
            InlineKeyboardButton("–ù–µ—Ç", callback_data="test_no"),
        ]
    ]
    await update.message.reply_text("–¢–µ—Å—Ç –∫–Ω–æ–ø–æ–∫:", reply_markup=InlineKeyboardMarkup(kb))


async def morning(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # —Å—Ç–∞—Ä—Ç —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –æ–ø—Ä–æ—Å–∞ (—Å–æ—Ö—Ä–∞–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ user_data)
    context.user_data["flow"] = {"name": "morning", "data": {}}

    kb = [
        [
            InlineKeyboardButton("–î–∞", callback_data="m_rested:1"),
            InlineKeyboardButton("–ù–µ—Ç", callback_data="m_rested:0"),
        ]
    ]
    await update.message.reply_text("üåÖ –£—Ç—Ä–æ: –≤—ã—Å–ø–∞–ª–∞—Å—å?", reply_markup=InlineKeyboardMarkup(kb))


def sleep_score_keyboard():
    row1 = [InlineKeyboardButton(str(i), callback_data=f"m_sleep:{i}") for i in range(0, 6)]
    row2 = [InlineKeyboardButton(str(i), callback_data=f"m_sleep:{i}") for i in range(6, 11)]
    return InlineKeyboardMarkup([row1, row2])


async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()  # —É–±–∏—Ä–∞–µ—Ç ‚Äú—á–∞—Å–∏–∫–∏‚Äù

    data = q.data or ""
    chat_id = q.message.chat_id

    # —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏
    if data == "test_yes":
        await q.message.reply_text("–û–∫, —Ç—ã –Ω–∞–∂–∞–ª–∞ –î–ê ‚úÖ")
        return
    if data == "test_no":
        await q.message.reply_text("–û–∫, —Ç—ã –Ω–∞–∂–∞–ª–∞ –ù–ï–¢ ‚ùå")
        return

    # MORNING flow
    flow = context.user_data.get("flow") or {}
    if flow.get("name") != "morning":
        await q.message.reply_text("–ü–æ—Ö–æ–∂–µ, –æ–ø—Ä–æ—Å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω. –ù–∞–ø–∏—à–∏ /morning")
        return

    parts = data.split(":")
    key = parts[0]
    val = parts[1] if len(parts) > 1 else ""

    d = flow["data"]

    if key == "m_rested":
        d["felt_rested"] = int(val)
        await q.message.reply_text("–û—Ü–µ–Ω–∫–∞ —Å–Ω–∞ 0‚Äì10?", reply_markup=sleep_score_keyboard())
        return

    if key == "m_sleep":
        d["sleep_score"] = int(val)
        kb = [
            [
                InlineKeyboardButton("–î–∞", callback_data="m_avamys_am:1"),
                InlineKeyboardButton("–ü—Ä–æ–ø—É—Å–∫", callback_data="m_avamys_am:0"),
            ]
        ]
        await q.message.reply_text("–ê–≤–∞–º–∏—Å —É—Ç—Ä–æ–º?", reply_markup=InlineKeyboardMarkup(kb))
        return

    if key == "m_avamys_am":
        d["avamys_am"] = int(val)
        kb = [
            [
                InlineKeyboardButton("–î–∞", callback_data="m_spf:1"),
                InlineKeyboardButton("–ù–µ—Ç", callback_data="m_spf:0"),
            ]
        ]
        await q.message.reply_text("SPF –Ω–∞–Ω–µ—Å—ë–Ω?", reply_markup=InlineKeyboardMarkup(kb))
        return

    if key == "m_spf":
        d["spf"] = int(val)

        now = datetime.now(TZ)
        # –ü–∏—à–µ–º –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –≤ Daily (–ø–æ–¥ —Ç–≤–æ—é —Ç–µ–∫—É—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–∑–∂–µ)
        append_row(
            "Daily",
            [
                now.strftime("%Y-%m-%d"),
                d.get("sleep_score", ""),
                d.get("felt_rested", ""),
                d.get("avamys_am", ""),
                d.get("spf", ""),
                "morning",
            ],
        )

        context.user_data.pop("flow", None)
        await q.message.reply_text("‚úÖ –£—Ç—Ä–æ –∑–∞–ø–∏—Å–∞–Ω–æ –≤ Daily.")
        return

    await q.message.reply_text("–û–∫.")


async def weekly(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # MVP: –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å + –∑–∞–ø–∏—Å—å
    kb = [
        [
            InlineKeyboardButton("–ó–∞–ø–æ–ª–Ω–∏—Ç—å weekly —Å–µ–π—á–∞—Å", callback_data="w_now:1"),
        ]
    ]
    await update.message.reply_text("üóì Weekly: –≥–æ—Ç–æ–≤–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç—å?", reply_markup=InlineKeyboardMarkup(kb))


async def handle_weekly_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    if not q or not q.data or not q.data.startswith("w_now:"):
        return
    await q.answer()

    now = datetime.now(TZ)
    append_row("Weekly", [now.strftime("%Y-%m-%d"), "weekly_ping"])
    await q.message.reply_text("‚úÖ Weekly –æ—Ç–º–µ—Ç–∫–∞ –∑–∞–ø–∏—Å–∞–Ω–∞ (–ø–æ–∫–∞ MVP).")


async def log_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –õ—é–±–æ–π —Ç–µ–∫—Å—Ç ‚Äî –≤ Daily –∫–∞–∫ —Å–≤–æ–±–æ–¥–Ω–∞—è –∑–∞–º–µ—Ç–∫–∞
    now = datetime.now(TZ)
    text = (update.message.text or "").strip()
    append_row("Daily", [now.strftime("%Y-%m-%d"), "", "", "", "", text])
    await update.message.reply_text("–ó–∞–ø–∏—Å–∞–Ω–æ.")


def main():
    app = Application.builder().token(TELEGRAM_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("buttons", buttons))
    app.add_handler(CommandHandler("morning", morning))
    app.add_handler(CommandHandler("weekly", weekly))

    app.add_handler(CallbackQueryHandler(handle_weekly_callback, pattern=r"^w_now:"))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, log_text))

    app.run_polling(allowed_updates=["message", "callback_query"])


if __name__ == "__main__":
    main()
