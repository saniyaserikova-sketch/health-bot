import os
import json
import threading
from datetime import datetime
from zoneinfo import ZoneInfo

from flask import Flask
import gspread
from google.oauth2.service_account import Credentials
from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    ContextTypes,
    filters,
)

# =====================
# ENV
# =====================

TELEGRAM_TOKEN = os.environ["TELEGRAM_TOKEN"]
SPREADSHEET_ID = os.environ["SPREADSHEET_ID"]
GOOGLE_SA_JSON = os.environ["GOOGLE_SA_JSON"]
TIMEZONE = os.getenv("TIMEZONE", "Asia/Almaty")
TZ = ZoneInfo(TIMEZONE)

# =====================
# Flask server (–¥–ª—è Render)
# =====================

web = Flask(__name__)

@web.get("/")
def health():
    return "ok", 200

def run_web():
    port = int(os.environ.get("PORT", 10000))
    web.run(host="0.0.0.0", port=port)

# =====================
# Google Sheets
# =====================

def sheets_client():
    info = json.loads(GOOGLE_SA_JSON)
    scopes = [
        "https://www.googleapis.com/auth/spreadsheets",
        "https://www.googleapis.com/auth/drive",
    ]
    creds = Credentials.from_service_account_info(info, scopes=scopes)
    gc = gspread.authorize(creds)
    return gc

def append_daily(row):
    gc = sheets_client()
    sh = gc.open_by_key(SPREADSHEET_ID)
    ws = sh.worksheet("Daily")
    ws.append_row(row, value_input_option="USER_ENTERED")

# =====================
# Telegram Handlers
# =====================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Health Bot –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ö–æ–º–∞–Ω–¥—ã: /morning /buttons")

async def buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = [
        [
            InlineKeyboardButton("–î–∞", callback_data="test_yes"),
            InlineKeyboardButton("–ù–µ—Ç", callback_data="test_no"),
        ]
    ]
    await update.message.reply_text("–¢–µ—Å—Ç –∫–Ω–æ–ø–æ–∫:", reply_markup=InlineKeyboardMarkup(kb))

async def morning(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["flow"] = {}
    kb = [
        [
            InlineKeyboardButton("–î–∞", callback_data="rested:1"),
            InlineKeyboardButton("–ù–µ—Ç", callback_data="rested:0"),
        ]
    ]
    await update.message.reply_text("üåÖ –í—ã—Å–ø–∞–ª–∞—Å—å?", reply_markup=InlineKeyboardMarkup(kb))

async def callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()

    data = q.data

    if data == "test_yes":
        await q.message.reply_text("–û–∫, —Ç—ã –Ω–∞–∂–∞–ª–∞ –î–ê ‚úÖ")
        return

    if data == "test_no":
        await q.message.reply_text("–û–∫, —Ç—ã –Ω–∞–∂–∞–ª–∞ –ù–ï–¢ ‚ùå")
        return

    flow = context.user_data.get("flow")

    if data.startswith("rested:"):
        flow["rested"] = int(data.split(":")[1])

        kb = [[
            InlineKeyboardButton(str(i), callback_data=f"sleep:{i}")
        ] for i in range(0, 11)]

        await q.message.reply_text("–û—Ü–µ–Ω–∫–∞ —Å–Ω–∞ 0‚Äì10?", reply_markup=InlineKeyboardMarkup(kb))
        return

    if data.startswith("sleep:"):
        flow["sleep_score"] = int(data.split(":")[1])

        now = datetime.now(TZ)

        append_daily([
            now.strftime("%Y-%m-%d"),
            flow.get("sleep_score", ""),
            flow.get("rested", ""),
            "",
            "",
        ])

        context.user_data.pop("flow", None)
        await q.message.reply_text("‚úÖ –£—Ç—Ä–æ –∑–∞–ø–∏—Å–∞–Ω–æ.")
        return

# =====================
# Main
# =====================

def main():
    threading.Thread(target=run_web, daemon=True).start()

    app = Application.builder().token(TELEGRAM_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("buttons", buttons))
    app.add_handler(CommandHandler("morning", morning))
    app.add_handler(CallbackQueryHandler(callback_handler))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, lambda u, c: None))

    app.run_polling(allowed_updates=["message", "callback_query"])

if __name__ == "__main__":
    main()
